---
title: 微服务框架与实战-笔记03-开始使用SpringCloud实战微服务
categories: 学习
tags:
  - 微服务
toc: true
date: 2018-01-21 23:50:00
scaffolds:
---

配套代码
- http://www.broadview.com.cn/book/4774  可以去勘误等
- 1-11 章配套代码：
https://github.com/itmuch/spring-cloud-docker-microservice-book-code
- 12-14 章配套代码：
https://github.com/itmuch/spring-cloud-docker-microservice-book-code-docker

# 实战前提
## 技术储备
- 语言基础：java或scala、Groovy
- spring boot ：
- 项目管理和构建工具：maven gradle （可以相互转换）
## 工具及软件版本
- JKD：官方建议1.8，也可以用1.7
- springboot： 书中使用1.4.5.RELEASE
- springCloud：Camden SR4
- IDE：Spring Tool suite 3.8.3 基于eclipse的IDE ，idea
- maven：3.3.9 （3.3.x运行在JDK1.8以上）
降低学习成本的重要方法之一:`少踩坑`
# 服务提供者、服务消费者
描述微服务之间的调用关系  
服务提供者：被调用方  
服务消费者：调用方
# 编写服务提供者
Spring Data JPA作为持久层框架，H2作为数据库
## 编写项目
自己下载代码看吧，microservice-simple-provider-user
### pom.xml
`spring-boot-starter-web`：springMVC支持  
`spring-boot-starter-data-jpa`：Spring Data JPA支持
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <groupId>com.itmuch.cloud</groupId>
  <artifactId>microservice-simple-provider-user</artifactId>
  <version>0.0.1-SNAPSHOT</version>
  <packaging>jar</packaging>

  <!-- 引入spring boot的依赖 -->
  <parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>1.4.3.RELEASE</version>
  </parent>

  <properties>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <java.version>1.8</java.version>
  </properties>

  <dependencies>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>
    <dependency>
      <groupId>com.h2database</groupId>
      <artifactId>h2</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
  </dependencies>

  <!-- 引入spring cloud的依赖 -->
  <dependencyManagement>
    <dependencies>
      <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-dependencies</artifactId>
        <version>Camden.SR4</version>
        <type>pom</type>
        <scope>import</scope>
      </dependency>
    </dependencies>
  </dependencyManagement>

  <!-- 添加spring-boot的maven插件 -->
  <build>
    <plugins>
      <plugin>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-maven-plugin</artifactId>
      </plugin>
    </plugins>
  </build>
</project>
```

### classpath下schema.sql 建表语句
```sql
drop table user if exists;
create table user (id bigint generated by default as identity, username varchar(40), name varchar(20), age int(3), balance decimal(10,2), primary key (id));
```
### classpath下data.sql
```sql
insert into user (id, username, name, age, balance) values (1, 'account1', '张三', 20, 100.00);
insert into user (id, username, name, age, balance) values (2, 'account2', '李四', 28, 180.00);
insert into user (id, username, name, age, balance) values (3, 'account3', '王五', 32, 280.00);
```
### 用户实体类
```java
package com.itmuch.cloud.study.entity;

import java.math.BigDecimal;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;

@Entity
public class User {
  @Id
  @GeneratedValue(strategy = GenerationType.AUTO)
  private Long id;
  @Column
  private String username;
  @Column
  private String name;
  @Column
  private Integer age;
  @Column
  private BigDecimal balance;

  public Long getId() {
    return this.id;
  }

  public void setId(Long id) {
    this.id = id;
  }

  public String getUsername() {
    return this.username;
  }

  public void setUsername(String username) {
    this.username = username;
  }

  public String getName() {
    return this.name;
  }

  public void setName(String name) {
    this.name = name;
  }

  public Integer getAge() {
    return this.age;
  }

  public void setAge(Integer age) {
    this.age = age;
  }

  public BigDecimal getBalance() {
    return this.balance;
  }

  public void setBalance(BigDecimal balance) {
    this.balance = balance;
  }

}
```
## DAO
```java
package com.itmuch.cloud.study.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import com.itmuch.cloud.study.entity.User;

@Repository
public interface UserRepository extends JpaRepository<User, Long> {
}

```
## controller
`@GetMapping` Spring4.3新注解。组合注解，等价 @RequestMapping(method=RequestMethod.GET)  
还有`@PostMapping`、`@PutMapping`、`@DeleteMapping`、`@PatchMapping`
```java
package com.itmuch.cloud.study.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;

import com.itmuch.cloud.study.entity.User;
import com.itmuch.cloud.study.repository.UserRepository;

@RestController
public class UserController {
  @Autowired
  private UserRepository userRepository;

  @GetMapping("/{id}")
  public User findById(@PathVariable Long id) {
    User findOne = this.userRepository.findOne(id);
    return findOne;
  }
}
```
## 启动类
`@SpringBootApplication` 
- 声明是一个Spring boot项目
- 组合注解，整合了@Configuration、@EnableAutoConfiguration、@ComponentScan
- 并开启了SpringBoot组件扫描和自动配置功能
```java
package com.itmuch.cloud.study;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class ProviderUserApplication {
  public static void main(String[] args) {
    SpringApplication.run(ProviderUserApplication.class, args);
  }
}
```
## 配置文件 application.yml

SpringCloud、SpringBoot支持`properties`或者`yml格式`文件作为`配置文件`    
`yml文件格式`：YAML（Yet Another Markup Language）编写的文件格式。  
YAML和properties格式文件可以互相转换。  
yml文件有`严格的缩进`  
```yml
server:
  port: 8000
spring:
  jpa:
    generate-ddl: false
    show-sql: true
    hibernate:
      ddl-auto: none
  datasource:                           # 指定数据源
    platform: h2                        # 指定数据源类型
    schema: classpath:schema.sql        # 指定h2数据库的建表脚本
    data: classpath:data.sql            # 指定h2数据库的数据脚本
logging:                                # 配置日志级别，让hibernate打印出执行的SQL
  level:
    root: INFO
    org.hibernate: INFO
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    org.hibernate.type.descriptor.sql.BasicExtractor: TRACE
    
## INFO
info: 
  app: 
    name: @project.artifactId@
    encoding: @project.build.sourceEncoding@
    java:
      source: @java.version@
      target: @java.version@

```
测试：http://localhost:8000/1